#!/usr/bin/env node
var app=require("../app"),debug=require("debug")("wqms:server"),http=require("http"),Firebase=require("../firebase"),port=normalizePort(process.env.PORT||"3000");app.set("port",port);var server=http.createServer(app),io=require("socket.io")(server);function normalizePort(e){var r=parseInt(e,10);return isNaN(r)?e:r>=0&&r}function onError(e){if("listen"!==e.syscall)throw e;var r="string"==typeof port?"Pipe "+port:"Port "+port;switch(e.code){case"EACCES":console.error(r+" requires elevated privileges"),process.exit(1);break;case"EADDRINUSE":console.error(r+" is already in use"),process.exit(1);break;default:throw e}}function onListening(){var e=server.address(),r="string"==typeof e?"pipe "+e:"port "+e.port;debug("Listening on "+r)}server.listen(port),server.on("error",onError),server.on("listening",onListening);var ref_current=Firebase.current,ref_log=Firebase.log;ref_log.on("child_changed",function(e){e.key;let r=e.toJSON(),o=Object.keys(r)[0];o==Firebase.getDate("_")&&io.emit("BasicInfoToday",{basicInfoToday:Firebase.BasicInfoToday(r[o])})}),ref_current.on("child_changed",function(e){let r=e.key,o=e.toJSON(),i=Firebase.UpdateDashboard(o),t={loc:r,info:Firebase.BasicInfo(o)};io.emit("UpdateDashboard",{loc:r,current_value:i}),io.emit("BasicInfo",{basicInfo:t})});